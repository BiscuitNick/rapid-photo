# AWS Credentials and Environment Setup

This guide explains how to manage AWS credentials and environment variables across the RapidPhotoUpload monorepo.

## Overview

RapidPhotoUpload requires AWS credentials for:
- **Backend**: S3, SQS, Cognito, CloudWatch, X-Ray
- **Lambda**: S3, Rekognition, RDS, CloudWatch
- **Mobile**: Amplify (uses Cognito for auth)
- **Web**: Amplify (uses Cognito for auth)

## Credential Hierarchy

### 1. AWS CLI Configuration (Recommended for Development)

```bash
# Configure AWS CLI
aws configure

# This creates ~/.aws/credentials
[default]
aws_access_key_id = YOUR_ACCESS_KEY
aws_secret_access_key = YOUR_SECRET_KEY
region = us-east-1
```

### 2. Environment Variables

```bash
# Export AWS credentials
export AWS_ACCESS_KEY_ID=YOUR_ACCESS_KEY
export AWS_SECRET_ACCESS_KEY=YOUR_SECRET_KEY
export AWS_REGION=us-east-1
```

### 3. IAM Roles (Recommended for Production)

Production deployments should use IAM roles:
- **ECS Tasks**: Task IAM Role
- **Lambda Functions**: Execution Role
- **EC2 Instances**: Instance Profile

## Environment Variables per Workspace

### Backend (.env)

```bash
# Database
DB_HOST=localhost
DB_PORT=5432
DB_NAME=rapidphoto
DB_USERNAME=rapidphoto
DB_PASSWORD=changeme

# AWS Configuration
AWS_REGION=us-east-1
AWS_ACCESS_KEY_ID=
AWS_SECRET_ACCESS_KEY=

# Cognito
COGNITO_USER_POOL_ID=us-east-1_XXXXXXX
COGNITO_CLIENT_ID=xxxxxxxxxxxxxxxxxxxxxxxxxx
COGNITO_ISSUER_URI=https://cognito-idp.us-east-1.amazonaws.com/us-east-1_XXXXXXX
COGNITO_JWK_SET_URI=https://cognito-idp.us-east-1.amazonaws.com/us-east-1_XXXXXXX/.well-known/jwks.json

# S3
S3_BUCKET_NAME=rapid-photo-uploads-dev
S3_PRESIGNED_URL_EXPIRATION=3600

# SQS
SQS_QUEUE_URL=https://sqs.us-east-1.amazonaws.com/123456789012/rapid-photo-processing

# CloudWatch
CLOUDWATCH_ENABLED=false
CLOUDWATCH_NAMESPACE=RapidPhoto

# Tracing
TRACING_PROBABILITY=0.1
```

### Lambda (.env)

```bash
# AWS Configuration
AWS_REGION=us-east-1

# Database
DB_HOST=rapid-photo-db.xxxxxxxx.us-east-1.rds.amazonaws.com
DB_PORT=5432
DB_NAME=rapidphoto
DB_USERNAME=lambda_user
DB_PASSWORD=secure_password

# S3
S3_BUCKET_NAME=rapid-photo-uploads-prod
THUMBNAILS_BUCKET=rapid-photo-thumbnails
PROCESSED_BUCKET=rapid-photo-processed

# Rekognition
REKOGNITION_MIN_CONFIDENCE=80
REKOGNITION_MAX_LABELS=20

# Logging
LOG_LEVEL=INFO
```

### Mobile (No .env needed)

Flutter uses `amplify_outputs.json` generated by Amplify CLI:

```json
{
  "auth": {
    "aws_region": "us-east-1",
    "user_pool_id": "us-east-1_XXXXXXX",
    "user_pool_client_id": "xxxxxxxxxxxxxxxxxxxxxxxxxx"
  },
  "storage": {
    "aws_region": "us-east-1",
    "bucket_name": "rapid-photo-uploads-dev"
  }
}
```

### Web (.env.local)

```bash
# Amplify
VITE_AWS_REGION=us-east-1
VITE_COGNITO_USER_POOL_ID=us-east-1_XXXXXXX
VITE_COGNITO_CLIENT_ID=xxxxxxxxxxxxxxxxxxxxxxxxxx

# API
VITE_API_BASE_URL=http://localhost:8080
VITE_API_TIMEOUT=30000

# Storage
VITE_S3_BUCKET=rapid-photo-uploads-dev
VITE_MAX_UPLOAD_SIZE=52428800

# Feature Flags
VITE_ENABLE_ANALYTICS=false
VITE_ENABLE_DEBUG=true
```

## Local Development Setup

### 1. Copy Example Files

```bash
# Root level
cp .env.example .env

# Backend
cp backend/.env.example backend/.env

# Lambda
cp lambda/.env.example lambda/.env

# Web
cp web/.env.example web/.env.local
```

### 2. Configure LocalStack (Optional)

For offline development with AWS services:

```bash
# Install LocalStack
pip install localstack

# Start LocalStack
localstack start

# Configure AWS CLI for LocalStack
export AWS_ENDPOINT_URL=http://localhost:4566
```

### 3. Database Setup

```bash
# Start PostgreSQL via Docker
docker run -d \
  --name rapidphoto-postgres \
  -e POSTGRES_DB=rapidphoto \
  -e POSTGRES_USER=rapidphoto \
  -e POSTGRES_PASSWORD=rapidphoto_dev \
  -p 5432:5432 \
  postgres:17.6
```

## Production Environment Setup

### AWS Systems Manager Parameter Store

Store sensitive values in AWS SSM Parameter Store:

```bash
# Store database password
aws ssm put-parameter \
  --name /rapidphoto/prod/db/password \
  --value "secure_password" \
  --type SecureString

# Store Cognito client secret
aws ssm put-parameter \
  --name /rapidphoto/prod/cognito/client-secret \
  --value "client_secret_value" \
  --type SecureString
```

### AWS Secrets Manager

For more complex secrets:

```bash
# Create secret
aws secretsmanager create-secret \
  --name rapidphoto/prod/database \
  --secret-string '{
    "username": "rapidphoto",
    "password": "secure_password",
    "engine": "postgres",
    "host": "rapid-photo-db.xxxxxxxx.us-east-1.rds.amazonaws.com",
    "port": 5432,
    "dbname": "rapidphoto"
  }'
```

### Environment Variables in ECS

```json
{
  "containerDefinitions": [
    {
      "name": "rapid-photo-backend",
      "secrets": [
        {
          "name": "DB_PASSWORD",
          "valueFrom": "arn:aws:ssm:us-east-1:123456789012:parameter/rapidphoto/prod/db/password"
        }
      ],
      "environment": [
        {
          "name": "AWS_REGION",
          "value": "us-east-1"
        },
        {
          "name": "SPRING_PROFILES_ACTIVE",
          "value": "prod"
        }
      ]
    }
  ]
}
```

## Security Best Practices

1. **Never commit credentials to Git**
   - Add `.env*` to `.gitignore`
   - Use `.env.example` files as templates

2. **Rotate credentials regularly**
   - Use AWS IAM rotation policies
   - Update SSM parameters quarterly

3. **Use IAM roles in production**
   - Avoid long-lived access keys
   - Follow principle of least privilege

4. **Encrypt sensitive data**
   - Use SSM SecureString parameters
   - Enable encryption at rest for S3/RDS

5. **Audit credential usage**
   - Enable CloudTrail logging
   - Monitor IAM Access Advisor

## Credential Mapping Matrix

| Workspace | Development | Testing | Production |
|-----------|------------|---------|------------|
| Backend | `.env` file | Environment variables | ECS Task Role + SSM |
| Lambda | `.env` file | Environment variables | Execution Role + Secrets Manager |
| Mobile | `amplify_outputs.json` | `amplify_outputs.test.json` | `amplify_outputs.prod.json` |
| Web | `.env.local` | `.env.test` | Build-time environment variables |

## Troubleshooting

### Invalid Credentials

```bash
# Verify AWS CLI configuration
aws sts get-caller-identity

# Check environment variables
env | grep AWS
```

### Permission Denied

```bash
# Check IAM permissions
aws iam get-user
aws iam list-attached-user-policies --user-name YOUR_USERNAME
```

### Wrong Region

```bash
# Verify AWS region
echo $AWS_REGION
aws configure get region
```

## References

- [AWS IAM Best Practices](https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html)
- [AWS Systems Manager Parameter Store](https://docs.aws.amazon.com/systems-manager/latest/userguide/systems-manager-parameter-store.html)
- [AWS Secrets Manager](https://docs.aws.amazon.com/secretsmanager/)
