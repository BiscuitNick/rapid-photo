spring:
  application:
    name: rapid-photo-backend

  # R2DBC Configuration (Reactive PostgreSQL)
  r2dbc:
    url: r2dbc:postgresql://${DB_HOST:localhost}:${DB_PORT:5432}/${DB_NAME:rapidphoto}
    username: ${DB_USERNAME:rapidphoto}
    password: ${DB_PASSWORD:changeme}
    properties:
      sslMode: ${DB_SSL_MODE:disable}
    pool:
      initial-size: 10
      max-size: 20
      max-idle-time: 30m
      max-acquire-time: 3s
      max-create-connection-time: 5s

  # Flyway Configuration (for schema migrations)
  flyway:
    enabled: true
    locations: classpath:db/migration
    baseline-on-migrate: true
    baseline-version: 0
    validate-on-migrate: true
    out-of-order: false
    # JDBC URL for Flyway (Flyway doesn't support R2DBC yet)
    url: jdbc:postgresql://${DB_HOST:localhost}:${DB_PORT:5432}/${DB_NAME:rapidphoto}${DB_SSL_PARAMS:}
    user: ${DB_USERNAME:rapidphoto}
    password: ${DB_PASSWORD:changeme}

  # Security (Cognito/Amplify OAuth2)
  security:
    oauth2:
      resourceserver:
        jwt:
          issuer-uri: ${COGNITO_ISSUER_URI:https://cognito-idp.us-east-1.amazonaws.com/us-east-1_XXXXXXX}
          jwk-set-uri: ${COGNITO_JWK_SET_URI:https://cognito-idp.us-east-1.amazonaws.com/us-east-1_XXXXXXX/.well-known/jwks.json}

  # Data source for Flyway (JDBC)
  datasource:
    url: jdbc:postgresql://${DB_HOST:localhost}:${DB_PORT:5432}/${DB_NAME:rapidphoto}${DB_SSL_PARAMS:}
    username: ${DB_USERNAME:rapidphoto}
    password: ${DB_PASSWORD:changeme}
    driver-class-name: org.postgresql.Driver

# AWS Configuration
aws:
  region: ${AWS_REGION:us-east-1}
  endpoint: ${AWS_ENDPOINT:} # For LocalStack in local dev
  s3:
    bucket-name: ${S3_BUCKET_NAME:rapid-photo-uploads}
    presigned-url-expiration: ${S3_PRESIGNED_URL_EXPIRATION:15} # Minutes (for uploads)
    download-url-expiration: ${S3_DOWNLOAD_URL_EXPIRATION:15} # Minutes (for downloads)
  sqs:
    photo-upload-queue: ${SQS_PHOTO_UPLOAD_QUEUE:photo-upload-events}

# Lambda Configuration
lambda:
  secret: ${LAMBDA_SECRET:rapid-photo-lambda-secret-change-in-production}

# Management/Actuator
management:
  endpoints:
    web:
      base-path: /actuator
      exposure:
        include: health,info,metrics,prometheus
  endpoint:
    health:
      show-details: when-authorized
  health:
    defaults:
      enabled: true
  metrics:
    export:
      cloudwatch:
        enabled: ${CLOUDWATCH_ENABLED:false}
        namespace: ${CLOUDWATCH_NAMESPACE:RapidPhoto}
        batch-size: 20
        step: 1m
    tags:
      application: ${spring.application.name}
      environment: ${SPRING_PROFILES_ACTIVE:default}
  tracing:
    sampling:
      probability: ${TRACING_PROBABILITY:0.1}

# Logging
logging:
  level:
    root: WARN
    com.rapidphoto: INFO  # Enable INFO logs to see cache activity
    org.springframework.cache: DEBUG  # Enable cache framework debugging
    org.springframework.boot: WARN
    org.springframework.web: WARN
    org.springframework.context: WARN
    org.springframework.data: WARN
    org.springframework.security: WARN
    org.springframework.r2dbc: WARN
    org.flywaydb: WARN
    io.r2dbc.postgresql: WARN
    io.netty: WARN
    reactor.netty: WARN
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"

# Application specific configuration
app:
  upload:
    max-file-size: ${MAX_UPLOAD_SIZE:52428800} # 50MB in bytes
    max-concurrent-uploads-per-user: ${MAX_CONCURRENT_UPLOADS:100}
    allowed-mime-types: image/jpeg,image/png,image/heic,image/webp

---
# Local Development Profile
spring:
  config:
    activate:
      on-profile: local

  r2dbc:
    url: r2dbc:postgresql://localhost:5432/rapidphoto
    username: rapidphoto
    password: rapidphoto_dev

  flyway:
    url: jdbc:postgresql://localhost:5432/rapidphoto
    user: rapidphoto
    password: rapidphoto_dev
    clean-disabled: false # Allow clean for local dev

  datasource:
    url: jdbc:postgresql://localhost:5432/rapidphoto
    username: rapidphoto
    password: rapidphoto_dev

  security:
    oauth2:
      resourceserver:
        jwt:
          issuer-uri: http://localhost:8080/mock-cognito # Mock for local testing

aws:
  endpoint: http://localhost:4566 # LocalStack endpoint
  s3:
    bucket-name: rapid-photo-uploads-local
  sqs:
    photo-upload-queue: photo-upload-events-local

management:
  metrics:
    export:
      cloudwatch:
        enabled: false

logging:
  level:
    root: WARN
    com.rapidphoto: WARN
    org.springframework.boot: WARN
    org.springframework.web: WARN
    org.springframework.context: WARN
    org.springframework.data: WARN
    org.springframework.security: WARN
    org.springframework.r2dbc: WARN
    org.flywaydb: WARN
    io.r2dbc.postgresql: WARN
    io.netty: WARN
    reactor.netty: WARN

---
# Test Profile
spring:
  config:
    activate:
      on-profile: test

  r2dbc:
    url: r2dbc:tc:postgresql:///rapidphoto_test?TC_IMAGE_TAG=17.6
    # Testcontainers will automatically configure these

  flyway:
    enabled: true
    clean-disabled: false # Allow clean for tests
    # Testcontainers will configure the JDBC URL

  security:
    oauth2:
      resourceserver:
        jwt:
          issuer-uri: http://localhost:8080/mock-cognito

management:
  metrics:
    export:
      cloudwatch:
        enabled: false

logging:
  level:
    root: WARN
    com.rapidphoto: WARN
    org.testcontainers: WARN

---
# Production Profile
spring:
  config:
    activate:
      on-profile: prod

  r2dbc:
    pool:
      initial-size: 20
      max-size: 50

  flyway:
    clean-disabled: true # Never allow clean in production
    validate-on-migrate: true

management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics
  metrics:
    export:
      cloudwatch:
        enabled: true
  tracing:
    sampling:
      probability: 0.5 # Higher sampling in prod for observability

logging:
  level:
    root: WARN
    com.rapidphoto: INFO  # Enable INFO logs to see cache activity
    org.springframework.cache: DEBUG  # Enable cache framework debugging
    io.r2dbc.postgresql: WARN
    io.netty: WARN
    reactor.netty: WARN
    org.springframework.r2dbc: WARN
    org.springframework.boot: WARN
    org.springframework.web: WARN
    org.springframework.data.r2dbc: INFO
    org.springframework.security: INFO
