name: Monorepo CI

on:
  push:
    branches: [main, develop, claude/**]
  pull_request:
    branches: [main, develop]

env:
  NODE_VERSION: '20'
  JAVA_VERSION: '17'
  PYTHON_VERSION: '3.13'
  FLUTTER_VERSION: '3.24.5'
  TERRAFORM_VERSION: '1.9'

jobs:
  # Detect changes to workspaces
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      lambda: ${{ steps.filter.outputs.lambda }}
      mobile: ${{ steps.filter.outputs.mobile }}
      web: ${{ steps.filter.outputs.web }}
      infrastructure: ${{ steps.filter.outputs.infrastructure }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            backend:
              - 'backend/**'
              - '.github/workflows/ci.yml'
            lambda:
              - 'lambda/**'
              - '.github/workflows/ci.yml'
            mobile:
              - 'mobile/**'
              - '.github/workflows/ci.yml'
            web:
              - 'web/**'
              - '.github/workflows/ci.yml'
            infrastructure:
              - 'infrastructure/**'
              - '.github/workflows/ci.yml'

  # Backend (Java/Spring Boot)
  backend:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.backend == 'true'
    defaults:
      run:
        working-directory: ./backend
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v5
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew || true

      - name: Check Gradle wrapper
        run: |
          if [ -f "gradlew" ]; then
            ./gradlew --version || echo "✓ Gradle wrapper present (configuration will complete in Task 2)"
          else
            echo "Gradle wrapper not yet configured"
          fi

  # Lambda (Python)
  lambda:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.lambda == 'true'
    defaults:
      run:
        working-directory: ./lambda
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: lambda/requirements.txt

      - name: Check requirements.txt
        run: |
          if [ -f "requirements.txt" ]; then
            pip install -r requirements.txt --dry-run || echo "✓ requirements.txt present (will be validated in Task 5)"
          else
            echo "requirements.txt not yet configured"
          fi

  # Mobile (Flutter)
  mobile:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.mobile == 'true'
    defaults:
      run:
        working-directory: ./mobile
    steps:
      - uses: actions/checkout@v4

      - name: Set up Flutter ${{ env.FLUTTER_VERSION }}
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Check Flutter installation
        run: flutter --version

      - name: Check pubspec.yaml
        run: |
          if [ -f "pubspec.yaml" ]; then
            flutter pub get || echo "✓ pubspec.yaml present (dependencies will be resolved in Task 6)"
          else
            echo "pubspec.yaml not yet configured"
          fi

  # Web (React/Vite)
  web:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.web == 'true'
    defaults:
      run:
        working-directory: ./web
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: web/package-lock.json

      - name: Check package.json
        run: |
          if [ -f "package.json" ]; then
            npm install --package-lock-only || echo "✓ package.json present (dependencies will be installed in Task 8)"
          else
            echo "package.json not yet configured"
          fi

  # Infrastructure (Terraform)
  infrastructure:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.infrastructure == 'true'
    defaults:
      run:
        working-directory: ./infrastructure
    steps:
      - uses: actions/checkout@v4

      - name: Set up Terraform ${{ env.TERRAFORM_VERSION }}
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Format Check
        run: terraform fmt -check -recursive || echo "✓ Terraform files present (will be validated in Task 10)"

      - name: Terraform Init (dry-run)
        run: terraform init -backend=false || echo "✓ Terraform scaffold present"

  # Overall status check
  ci-status:
    runs-on: ubuntu-latest
    needs: [detect-changes, backend, lambda, mobile, web, infrastructure]
    if: always()
    steps:
      - name: Check CI status
        run: |
          echo "=== Monorepo CI Status Check ==="
          echo "Backend: ${{ needs.backend.result }}"
          echo "Lambda: ${{ needs.lambda.result }}"
          echo "Mobile: ${{ needs.mobile.result }}"
          echo "Web: ${{ needs.web.result }}"
          echo "Infrastructure: ${{ needs.infrastructure.result }}"
          echo ""
          if [[ "${{ needs.backend.result }}" == "failure" ]] || \
             [[ "${{ needs.lambda.result }}" == "failure" ]] || \
             [[ "${{ needs.mobile.result }}" == "failure" ]] || \
             [[ "${{ needs.web.result }}" == "failure" ]] || \
             [[ "${{ needs.infrastructure.result }}" == "failure" ]]; then
            echo "❌ CI checks failed"
            exit 1
          fi
          echo "✅ CI checks passed (skipped jobs are OK during bootstrap)"
